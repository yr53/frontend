<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CoreON - 게시글 수정</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;margin:0;background:#f5f7fb;color:#1f2937;}
    .wrap{max-width:960px;margin:24px auto;padding:0 16px;}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 8px 24px rgba(17,24,39,.06);padding:18px;}
    h1{font-size:20px;margin:0 0 12px;}
    label{display:block;font-size:13px;color:#6b7280;margin:12px 0 6px;}
    input,textarea,select{width:100%;border:1px solid #e5e7eb;border-radius:10px;padding:10px 12px;font-size:14px;box-sizing:border-box;}
    textarea{min-height:220px;resize:vertical;white-space:pre-wrap;}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    .btns{display:flex;gap:8px;justify-content:flex-end;margin-top:14px;flex-wrap:wrap;}
    button,.btn{border:1px solid #e5e7eb;background:#fff;border-radius:10px;padding:10px 12px;cursor:pointer;font-weight:700;}
    button.primary{background:#1f4bd8;border-color:#1f4bd8;color:#fff;}
    button:disabled{opacity:.5;cursor:not-allowed;}
    a.btn{display:inline-block;text-decoration:none;line-height:20px;}
    .hint{margin-top:10px;color:#b45309;font-size:13px;}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>게시글 수정</h1>

    <div class="row">
      <div>
        <label>분류(category)</label>
        <input id="category" placeholder="예: 공지, 자료, 공문" />
      </div>
      <div>
        <label>부서(dept)</label>
        <input id="dept" placeholder="예: 개발팀" />
      </div>
    </div>

    <label>제목(title)</label>
    <input id="title" />

    <label>내용(content)</label>
    <textarea id="content"></textarea>

    <div class="btns">
      <a class="btn" id="cancelBtn" href="/board/list.html">취소</a>
      <button class="primary" id="saveBtn">저장</button>
    </div>

    <div class="hint" id="hint"></div>
  </div>
</div>

<script>
  const $ = (id) => document.getElementById(id);

  function qs(name){
    return new URLSearchParams(location.search).get(name);
  }

  async function fetchJson(url, options={}){
    const res = await fetch(url, {
      credentials: "include",
      headers: { "Content-Type": "application/json", ...(options.headers||{}) },
      ...options
    });
    const text = await res.text();
    let data = null;
    try { data = text ? JSON.parse(text) : null; } catch(e) {}
    return { res, data, text };
  }

  const boardId = qs("boardId");
  if(!boardId){
    alert("boardId가 없습니다. 목록으로 이동합니다.");
    location.href = "/board/list.html";
  }

  let post = null;

  async function load(){
    $("hint").textContent = "";
    const {res, data, text} = await fetchJson(`/api/board/posts/${boardId}`, { method: "GET" });
    if(!res.ok){
      alert(text || "게시글 정보를 불러오지 못했습니다.");
      location.href = "/board/list.html";
      return;
    }

    post = data && data.post ? data.post : data;

    $("category").value = post.category || "";
    $("dept").value = post.dept || "";
    $("title").value = post.title || "";
    $("content").value = post.content || "";

    $("cancelBtn").href = `/board/detail.html?boardId=${boardId}`;
  }

  $("saveBtn").addEventListener("click", async ()=>{
    $("hint").textContent = "";

    const payload = {
      category: $("category").value.trim(),
      dept: $("dept").value.trim(),
      title: $("title").value.trim(),
      content: $("content").value
    };

    if(!payload.title){
      $("hint").textContent = "제목은 필수입니다.";
      return;
    }
    if(!payload.category){
      $("hint").textContent = "분류(category)는 필수입니다.";
      return;
    }

    // ✅ 백엔드에 PUT API가 있어야 동작
    const {res, text} = await fetchJson(`/api/board/posts/${boardId}`, {
      method: "PUT",
      body: JSON.stringify(payload)
    });

    if(res.ok){
      alert("수정되었습니다.");
      location.href = `/board/detail.html?boardId=${boardId}`;
      return;
    }

    if(res.status === 401){
      alert("로그인이 필요합니다.");
      return;
    }
    if(res.status === 403){
      alert("수정 권한이 없습니다.");
      return;
    }

    alert(text || `수정 실패: ${res.status}`);
  });

  load();
</script>
</body>
</html>
