<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>CoreON - 공지사항</title>
  <style>
    /* ===== Header (공통 헤더 스타일) ===== */
.main_div_header{
  max-width:1100px; margin:0 auto;
  padding:24px 20px 14px;
  text-align:center;
}
.main_div_header h1{margin:0; font-size:28px; letter-spacing:-.2px;}
.main_div_header h3{margin:8px 0 0; font-size:14px; color:var(--muted); font-weight:500;}

.top-nav{
  display:flex; justify-content:center; align-items:center;
  gap:26px; margin-top:18px; padding:10px 0 6px;
  flex-wrap:wrap;
}
.nav-item{
  font-size:14px; font-weight:600;
  padding:8px 6px; border-bottom:2px solid transparent;
  color:var(--text);
}
.nav-item:hover{color:var(--primary); border-bottom-color:var(--primary);}
.nav-item.active{color:var(--primary); border-bottom-color:var(--primary);}
.nav-item.action{
  padding:8px 12px; border:1px solid var(--line); border-radius:10px;
  background:#fff; font-weight:700;
}
.nav-item.action.primary{background:var(--primary); border-color:var(--primary); color:#fff;}
.nav-item.action.primary:hover{background:var(--primary-hover); border-color:var(--primary-hover);}

.logo-link { text-decoration:none; color:inherit; }
.logo-link:hover { color:inherit; }

    /* ====== CoreON Base ====== */
    :root{
      --bg:#f5f7fb;
      --surface:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;
      --line:#e5e7eb;
      --primary:#1f4bd8;
      --primary-hover:#193db0;
      --shadow:0 8px 24px rgba(17,24,39,.08);
      --radius:14px;
    }
    *{box-sizing:border-box;}
    body{
      margin:0; padding:0;
      background:var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR",Arial,sans-serif;
    }
    a{color:inherit;text-decoration:none;}

    /* ===== Header ===== */
    header{background:var(--surface); border-bottom:1px solid var(--line);}

    /* ===== Main ===== */
    main{max-width:1100px; margin:0 auto; padding:28px 20px 0;}
    .page-head{
      display:flex; justify-content:space-between; align-items:flex-end;
      gap:12px; flex-wrap:wrap;
      margin: 6px 0 16px;
    }
    .page-title{
      display:flex; flex-direction:column; gap:6px;
    }
    .page-title h2{margin:0; font-size:18px; font-weight:800;}
    .page-title p{margin:0; font-size:13px; color:var(--muted); line-height:1.6;}

    .tools{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .search{
      width: 260px;
      padding: 11px 12px;
      border:1px solid var(--line);
      border-radius:12px;
      outline:none;
      background:#fff;
      font-size:14px;
    }
    .search:focus{
      border-color: rgba(31,75,216,0.45);
      box-shadow: 0 0 0 4px rgba(31,75,216,0.10);
    }
    .btn{
      border:1px solid var(--line);
      background:#fff;
      padding:11px 14px;
      border-radius:12px;
      font-weight:800;
      cursor:pointer;
      font-size:14px;
      white-space:nowrap;
    }
    .btn.primary{
      background:var(--primary);
      border-color:var(--primary);
      color:#fff;
    }
    .btn.primary:hover{
      background:var(--primary-hover);
      border-color:var(--primary-hover);
      box-shadow:0 6px 16px rgba(31,75,216,0.18);
    }
    .btn:disabled{
      opacity:0.6;
      cursor:not-allowed;
    }

    /* ===== Layout ===== */
    .layout{
      display:grid;
      grid-template-columns: 1.6fr 0.9fr;
      gap:16px;
      align-items:start;
    }

    .card{
      background:var(--surface);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card-head{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .card-head .title{
      font-size:14px;
      font-weight:800;
      margin:0;
    }
    .card-head .desc{
      font-size:12px;
      color:var(--muted);
      margin:2px 0 0;
    }

    /* ===== Notice list ===== */
    .notice-list{
      display:flex;
      flex-direction:column;
      gap:10px;
      padding:12px;
      min-height: 120px;
    }
    .notice-item{
      border:1px solid var(--line);
      border-radius:12px;
      padding:12px 14px;
      background:#fff;
      cursor:pointer;
      transition: transform .15s ease, box-shadow .15s ease, border-color .15s ease;
    }
    .notice-item:hover{
      border-color: rgba(31,75,216,0.25);
      box-shadow: 0 6px 18px rgba(17,24,39,0.08);
      transform: translateY(-1px);
    }
    .row{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
      flex-wrap:wrap;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:12px;
      font-weight:800;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      white-space:nowrap;
    }
    .badge.important{
      border-color: rgba(31,75,216,0.35);
      background: rgba(31,75,216,0.08);
      color: var(--primary);
    }
    .badge.update{
      border-color: rgba(17,24,39,0.12);
      background: rgba(17,24,39,0.04);
      color: var(--text);
    }
    .notice-title{
      margin:0;
      font-size:14px;
      font-weight:900;
      letter-spacing:-.1px;
    }
    .notice-meta{
      margin-top:6px;
      font-size:12px;
      color:var(--muted);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .notice-preview{
      margin-top:8px;
      font-size:13px;
      color:var(--text);
      line-height:1.55;
      opacity:0.92;
    }

    /* ===== Pagination ===== */
    #pagination{
      border-top:1px solid var(--line);
      padding:10px 12px;
      display:flex;
      justify-content:flex-end;
      gap:8px;
      align-items:center;
    }
    .page-info{
      font-size:13px; color:var(--muted);
      padding:0 6px;
    }

    /* ===== Right panel ===== */
    .panel{
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .panel-box{
      border:1px solid var(--line);
      border-radius:12px;
      padding:12px;
      background:#fff;
    }
    .panel-box h4{
      margin:0 0 8px;
      font-size:13px;
      font-weight:900;
    }
    .panel-box p, .panel-box li{
      margin:0;
      color:var(--muted);
      font-size:12.5px;
      line-height:1.6;
    }
    .panel-box ul{
      margin:8px 0 0;
      padding-left:18px;
    }

    /* ===== Modal (공통) ===== */
    .modal-backdrop{
      position:fixed; inset:0;
      background: rgba(17,24,39,0.42);
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
      z-index:999;
    }
    .modal{
      width:min(720px, 100%);
      background: var(--surface);
      border:1px solid var(--line);
      border-radius: 16px;
      box-shadow: 0 18px 50px rgba(17,24,39,0.20);
      overflow:hidden;
    }
    .modal-head{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }
    .modal-head .m-title{
      margin:0;
      font-size:15px;
      font-weight:900;
      line-height:1.4;
    }
    .modal-head .m-meta{
      margin-top:6px;
      font-size:12px;
      color:var(--muted);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .modal-body{
      padding:16px;
      font-size:14px;
      line-height:1.7;
      white-space:pre-wrap;
    }
    .icon-btn{
      border:1px solid var(--line);
      background:#fff;
      border-radius:12px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:900;
    }
    .icon-btn:hover{
      border-color: rgba(17,24,39,0.15);
      box-shadow:0 6px 16px rgba(17,24,39,0.06);
    }
    

    /* ===== Footer ===== */
    footer{
      margin-top:80px;
      text-align:center;
      padding:20px 0;
      border-top:1px solid var(--line);
      color:var(--muted);
      font-size:13px;
      background:var(--surface);
    }

    @media (max-width: 960px){
      .layout{grid-template-columns: 1fr;}
      .search{width: 100%;}
    }
  </style>
</head>

<body>
<header>
  <div id="app-header"></div>
  <script src="/assets/app-header.js" defer></script>
</header>

<main>
  <div class="page-head">
    <div class="page-title">
      <h2>공지사항</h2>
      <p>중요 공지 및 시스템 업데이트를 확인합니다.</p>
    </div>

    <div class="tools">
      <input id="search" class="search" type="text" placeholder="공지 검색 (제목/내용)" />
      <button class="btn primary" type="button" onclick="openCreateModal()">공지 작성</button>
    </div>
  </div>

  <div class="layout">
    <!-- ===== Left: Notice List ===== -->
    <section class="card">
      <div class="card-head">
        <div>
          <p class="title">공지 목록</p>
          <p class="desc">고정 우선 + 최신 공지부터 표시됩니다.</p>
        </div>
        <button class="btn" type="button" onclick="resetSearch()">초기화</button>
      </div>

      <div class="notice-list" id="noticeList"></div>
      <div id="pagination"></div>
    </section>

    <!-- ===== Right: Info Panel ===== -->
    <aside class="card">
      <div class="card-head">
        <div>
          <p class="title">안내</p>
          <p class="desc">공지 운영 기준 및 바로가기</p>
        </div>
      </div>

      <div class="panel">
        <div class="panel-box">
          <h4>공지 작성 기준</h4>
          <ul>
            <li>전사 공지/시스템 점검/정책 변경 등 “중요 사항”만 공지로 등록</li>
            <li>팀별 공유/업무 진행 상황/히스토리는 게시판 이용</li>
            <li>제목에 분류 태그 권장: [점검], [업데이트], [안내]</li>
          </ul>
        </div>

        <div class="panel-box">
          <h4>바로가기</h4>
          <ul>
            <li><a href="/board/list.html">게시판으로 이동</a></li>
            <li><a href="/faq/faq.html">FAQ 챗봇</a></li>
          </ul>
        </div>

        <div class="panel-box">
          <h4>문의</h4>
          <p>접속/권한/오류 관련 문의는 IT 운영팀으로 전달해주세요.</p>
        </div>
      </div>
    </aside>
  </div>
</main>

<!-- ===== Detail Modal ===== -->
<div class="modal-backdrop" id="modalBackdrop" onclick="closeModal(event)">
  <div class="modal" role="dialog" aria-modal="true" onclick="event.stopPropagation()">
    <div class="modal-head">
      <div>
        <h3 class="m-title" id="mTitle">공지 제목</h3>
        <div class="m-meta" id="mMeta"></div>
      </div>
        <button class="btn" type="button" onclick="openEditFromDetail()">수정</button>
      <button class="btn" type="button" onclick="deleteFromDetail()">삭제</button>
      <button class="icon-btn" type="button" onclick="closeModal()">닫기</button>
    </div>

    <div class="modal-body">
      <div id="mBody"></div>

      <div style="margin-top:14px; padding-top:12px; border-top:1px solid var(--line);">
        <div style="font-size:13px; font-weight:900; margin-bottom:8px;">첨부파일</div>
        <div id="mAttachments" style="display:flex; flex-direction:column; gap:8px;"></div>
      </div>
    </div>
  </div>
</div>

<!-- ===== Create Modal ===== -->
<div class="modal-backdrop" id="createBackdrop" onclick="closeCreateModal(event)">
  <div class="modal" role="dialog" aria-modal="true" onclick="event.stopPropagation()">
    <div class="modal-head">
      <div>
        <h3 class="m-title">공지 작성</h3>
        <div class="m-meta" style="font-size:12px; color:var(--muted);">ADMIN만 등록 가능합니다.</div>
      </div>
      <button class="icon-btn" type="button" onclick="closeCreateModal()">닫기</button>
    </div>

    <div class="modal-body" style="white-space:normal;">
      <form id="createForm" onsubmit="submitCreateNotice(event)">
        <div style="display:flex; flex-direction:column; gap:8px;">
          <label style="font-size:13px; font-weight:900;">제목</label>
          <input id="cTitle" type="text" required
                 style="padding:11px 12px; border:1px solid var(--line); border-radius:12px; font-size:14px; outline:none;"
                 placeholder="제목을 입력하세요" />
        </div>

        <div style="display:flex; flex-direction:column; gap:8px; margin-top:12px;">
          <label style="font-size:13px; font-weight:900;">내용</label>
          <textarea id="cContent" required rows="8"
                    style="padding:11px 12px; border:1px solid var(--line); border-radius:12px; font-size:14px; outline:none; resize:vertical;"
                    placeholder="공지 내용을 입력하세요"></textarea>
        </div>

     
        <!-- 카테고리 / 부서 -->
<div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:12px;">
  <div style="display:flex; flex-direction:column; gap:8px;">
    <label style="font-size:13px; font-weight:900;">카테고리</label>
    <select id="cCategory" required
            style="padding:11px 12px; border:1px solid var(--line); border-radius:12px; font-size:14px; outline:none; background:#fff;">
      <option value="">선택</option>
      <option value="INSPECTION">점검</option>
      <option value="UPDATE">업데이트</option>
      <option value="GUIDE">가이드</option>
    </select>
  </div>

  

  
</div>
<div id="existingAttachmentsBox" style="margin-top:12px; display:none;">
          <div style="font-size:13px; font-weight:900; margin-bottom:8px;">기존 첨부파일</div>
          <div id="cExistingAttachments" style="display:flex; flex-direction:column; gap:8px;"></div>
          <div style="margin-top:6px; font-size:12px; color:var(--muted);">
            기존 첨부파일은 개별 삭제할 수 있습니다. (삭제 즉시 반영)
          </div>
        </div>

        <div style="margin-top:12px;">
          <div style="font-size:13px; font-weight:900; margin-bottom:8px;">첨부파일 (선택)</div>
          <input id="cFiles" type="file" multiple />
          <div style="margin-top:6px; font-size:12px; color:var(--muted);">
            공지 등록 성공 후, 첨부 업로드 API로 자동 전송됩니다.
          </div>
        </div>

        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:16px;">
          <button class="btn" type="button" onclick="closeCreateModal()">취소</button>
          <button class="btn primary" id="createSubmitBtn" type="submit">등록</button>
        </div>
      </form>
    </div>
  </div>
</div>

<footer>
  Copyright CoreON
</footer>

<script>
  // =========================
  // 0) API 기본 설정 (요구사항: Notice_BASE)
  // =========================
  // 개발 환경에서 프론트가 별도 포트면 full URL 사용
  const Notice_BASE = "http://localhost:8082/api/notice";
  let currentNoticeId = null;
  let formMode = "create";       
  let editingNoticeId = null;   
  let currentDetail = null; // 상세조회한 공지를 임시로 들고 있음




  // 상태
  let state = {
  page: 1,
  size: 5,          // ✅ 5개씩
  q: "",
  total: 0,
  totalPages: 1,
  all: [],          // ✅ 전체 목록 캐시
  items: []
};


  // 엘리먼트
  const noticeListEl = document.getElementById("noticeList");
  const searchInput = document.getElementById("search");
  const paginationEl = document.getElementById("pagination");

  // 공통 fetch (세션 쿠키 포함)
  async function apiFetch(url, options = {}) {
    const res = await fetch(url, {
      ...options,
      credentials: "include"
    });

    if (res.status === 401) {
      alert("로그인이 필요합니다.");
      throw new Error("401 Unauthorized");
    }
    if (res.status === 403) {
      alert("권한이 없습니다.");
      throw new Error("403 Forbidden");
    }

    if (!res.ok) {
      const text = await res.text().catch(() => "");
      throw new Error(`HTTP ${res.status} - ${text}`);
    }

    const ct = res.headers.get("content-type") || "";
    if (ct.includes("application/json")) return res.json();
    return res.text();
  }

  function formatDateTime(iso) {
    if (!iso) return "";
    return iso.replace("T", " ").slice(0, 16);
  }

  function badgeHtml(item) {
    if (item.isImportant) return `<span class="badge important">중요</span>`;
    if (item.isPinned) return `<span class="badge update">고정</span>`;
    return `<span class="badge">안내</span>`;
  }

  function escapeHtml(str) {
    return String(str ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  // =========================
  // 1) 목록 조회 (GET /items)
  // =========================
const CATEGORY_LABEL = {
  INSPECTION: "점검",
  UPDATE: "업데이트",
  GUIDE: "가이드"
};

function categoryBadge(category) {
  const label = CATEGORY_LABEL[category] ?? (category ?? "안내");
  // 기존 CSS 클래스 재활용: 점검=important, 업데이트=update, 가이드는 기본
  const cls =
    category === "INSPECTION" ? "important" :
    category === "UPDATE" ? "update" : "";
  return `<span class="badge ${cls}">${escapeHtml(label)}</span>`;
}

async function loadNotices() {
  noticeListEl.innerHTML = `
    <div style="padding:16px; color:var(--muted); font-size:13px;">
      불러오는 중...
    </div>
  `;
  paginationEl.innerHTML = "";

  const params = new URLSearchParams();
  if (state.q) params.set("q", state.q);

  const url = `${Notice_BASE}/items?${params.toString()}`;
  const data = await apiFetch(url);

  const all = Array.isArray(data) ? data : (data.items ?? data.content ?? []);
  state.all = all;
  state.total = all.length;

  applyPaging();        // ✅ state.items 계산
  renderNoticeList();
  renderPagination();
}

function applyPaging() {
  state.totalPages = Math.max(1, Math.ceil(state.total / state.size));

  if (state.page > state.totalPages) state.page = state.totalPages;
  if (state.page < 1) state.page = 1;

  const start = (state.page - 1) * state.size;
  const end = start + state.size;
  state.items = state.all.slice(start, end);
}




 function renderNoticeList() {
  noticeListEl.innerHTML = "";

  if (!state.items.length) {
    noticeListEl.innerHTML = `
      <div style="padding:16px; color:var(--muted); font-size:13px;">
        표시할 공지가 없습니다.
      </div>
    `;
    return;
  }

  state.items.forEach((item) => {
    const el = document.createElement("article");
    el.className = "notice-item";
    el.onclick = () => openNotice(item.noticeId);

    const createdAt = formatDateTime(item.createdAt);
    const updatedAt = formatDateTime(item.updatedAt);
    const dept = item.publisherDept ?? "";
    const createdBy = item.createdBy ?? "";

    // 내용 프리뷰
    const preview = (item.content ?? "").replace(/\s+/g, " ").trim();
    const snippet = preview.length > 90 ? preview.slice(0, 90) + "..." : preview;

    el.innerHTML = `
      <div class="row">
        <p class="notice-title">${escapeHtml(item.title ?? "")}</p>
        ${categoryBadge(item.category)}
      </div>

      <div class="notice-meta">
        <span>작성 ${escapeHtml(createdAt)}</span>
        ${updatedAt ? `<span>수정 ${escapeHtml(updatedAt)}</span>` : ""}
        ${dept ? `<span>${escapeHtml(dept)}</span>` : ""}
        ${createdBy ? `<span>${escapeHtml(createdBy)}</span>` : ""}
      </div>

      <div class="notice-preview">${escapeHtml(snippet || "클릭하여 상세 내용을 확인하세요.")}</div>
    `;

    noticeListEl.appendChild(el);
  });
}


  // =========================
  // 2) 상세 조회 (GET /items/{noticeId}) + 첨부 렌더링
  // =========================
async function openNotice(noticeId) {
  currentNoticeId = noticeId;
  const detail = await apiFetch(`${Notice_BASE}/items/${noticeId}`);

  // ✅ 전역 currentDetail에 저장 (noticeId도 안전하게 보강)
  currentDetail = { ...(detail || {}), noticeId };

  document.getElementById("mTitle").innerText = currentDetail.title ?? "";

  const createdAt = formatDateTime(currentDetail.createdAt);
  const updatedAt = formatDateTime(currentDetail.updatedAt);
  const dept = currentDetail.publisherDept ?? "";
  const createdBy = currentDetail.createdBy ?? "";

  document.getElementById("mMeta").innerHTML = `
    ${createdAt ? `<span style="font-size:12px; color: var(--muted);">작성 ${escapeHtml(createdAt)}</span>` : ""}
    ${updatedAt ? `<span style="font-size:12px; color: var(--muted);">수정 ${escapeHtml(updatedAt)}</span>` : ""}
    ${dept ? `<span style="font-size:12px; color: var(--muted);">${escapeHtml(dept)}</span>` : ""}
    ${createdBy ? `<span style="font-size:12px; color: var(--muted);">${escapeHtml(createdBy)}</span>` : ""}
    ${currentDetail.category ? categoryBadge(currentDetail.category) : ""}
  `;

  document.getElementById("mBody").innerText = currentDetail.content ?? "";

  await loadAttachmentsIntoModal(noticeId);
  document.getElementById("modalBackdrop").style.display = "flex";
}



  async function loadAttachmentsIntoModal(noticeId) {
    const host = document.getElementById("mAttachments");
    if (!host) return;

    host.innerHTML = `<div style="color:var(--muted); font-size:12.5px;">불러오는 중...</div>`;

    const list = await apiFetch(`${Notice_BASE}/items/${noticeId}/attachments`);
    if (!Array.isArray(list) || list.length === 0) {
      host.innerHTML = `<div style="color:var(--muted); font-size:12.5px;">첨부파일이 없습니다.</div>`;
      return;
    }

    host.innerHTML = "";
    list.forEach((a) => {
      const row = document.createElement("div");
      row.style.display = "flex";
      row.style.gap = "8px";
      row.style.alignItems = "center";
      row.style.justifyContent = "space-between";
      row.style.border = "1px solid var(--line)";
      row.style.borderRadius = "12px";
      row.style.padding = "10px 12px";
      row.style.background = "#fff";

      const left = document.createElement("div");
      left.style.display = "flex";
      left.style.flexDirection = "column";
      left.style.gap = "2px";

      const name = document.createElement("div");
      name.style.fontSize = "13px";
      name.style.fontWeight = "800";
      name.innerText = a.originalName ?? ("attachment#" + a.attachmentId);

      const meta = document.createElement("div");
      meta.style.fontSize = "12px";
      meta.style.color = "var(--muted)";
      meta.innerText = `${a.contentType ?? ""}  ${a.sizeBytes ? (a.sizeBytes + " bytes") : ""}`;

      left.appendChild(name);
      left.appendChild(meta);

      const btn = document.createElement("button");
      btn.className = "btn primary";
      btn.type = "button";
      btn.innerText = "다운로드";
      btn.onclick = async () => {
        try {
          const data = await apiFetch(`${Notice_BASE}/attachments/${a.attachmentId}/download`);
          if (data && data.downloadUrl) {
            window.open(data.downloadUrl, "_blank");
          } else {
            alert("다운로드 URL 발급에 실패했습니다.");
          }
        } catch (e) {
          console.error(e);
          alert("다운로드 처리 중 오류가 발생했습니다.");
        }
      };

      row.appendChild(left);
      row.appendChild(btn);
      host.appendChild(row);
    });
  }

  function openEditFromDetail() {
  if (!currentDetail) {
    alert("상세 정보를 먼저 불러와야 합니다.");
    return;
  }
  closeModal(); // 상세 모달 닫고
  openCreateModal("edit", currentDetail); // 작성 모달을 수정 모드로
}

function closeCreateModal() {
  document.getElementById("createBackdrop").style.display = "none";
  formMode = "create";
  editingNoticeId = null;
}


  function closeModal() {
    document.getElementById("modalBackdrop").style.display = "none";
  }

  // =========================
  // 3) 검색 (서버 q)
  // =========================
  let searchTimer = null;
  if (searchInput) {
    searchInput.addEventListener("input", () => {
      clearTimeout(searchTimer);
      searchTimer = setTimeout(() => {
        state.q = searchInput.value.trim();
        state.page = 1;
        loadNotices().catch(console.error);
      }, 250);
    });
  }

  function resetSearch() {
    if (searchInput) searchInput.value = "";
    state.q = "";
    state.page = 1;
    loadNotices().catch(console.error);
  }

  // =========================
  // 4) 공지 작성 (POST /items) + (선택) 첨부 업로드
  // =========================
 function openCreateModal(mode = "create", detail = null) {
  const form = document.getElementById("createForm");
  if (form) form.reset();

  formMode = mode;
  editingNoticeId = (mode === "edit") ? (detail?.noticeId ?? null) : null;

  // 타이틀/설명 변경
  const titleEl = document.getElementById("createModalTitle");
  if (titleEl) titleEl.innerText = (mode === "edit") ? "공지 수정" : "공지 작성";

  const descEl = document.getElementById("createModalDesc");
  if (descEl) descEl.innerText = "ADMIN만 가능합니다.";

  // edit 모드면 기존 값 채우기
  if (mode === "edit" && detail) {
    const cTitle = document.getElementById("cTitle");
    const cContent = document.getElementById("cContent");
    const cCategory = document.getElementById("cCategory");
    const cFiles = document.getElementById("cFiles");

    if (cTitle) cTitle.value = detail.title ?? "";
    if (cContent) cContent.value = detail.content ?? "";
    if (cCategory) cCategory.value = detail.category ?? "GUIDE";
    if (cFiles) cFiles.value = ""; // 보안상 파일 input은 값 세팅 불가/무의미 -> 비워둠
  }

  const btn = document.getElementById("createSubmitBtn");
  if (btn) {
    btn.disabled = false;
    btn.innerText = (mode === "edit") ? "수정" : "등록";
  }

  document.getElementById("createBackdrop").style.display = "flex";

  // ✅ edit 모드면 기존 첨부도 불러오기 / create면 숨기기
const box = document.getElementById("existingAttachmentsBox");
const host = document.getElementById("cExistingAttachments");

if (mode === "edit" && editingNoticeId) {
  loadExistingAttachmentsForEdit(editingNoticeId).catch(console.error);
} else {
  if (box) box.style.display = "none";
  if (host) host.innerHTML = "";
}

}


let creating = false;

async function submitCreateNotice(e) {
  e.preventDefault();
  if (creating) return;
  creating = true;

  const category = (document.getElementById("cCategory")?.value || "").trim();
  const title = (document.getElementById("cTitle")?.value || "").trim();
  const content = (document.getElementById("cContent")?.value || "").trim();

  if (!category) { alert("카테고리를 선택하세요."); creating = false; return; }
  if (!title || !content) { alert("제목/내용을 입력하세요."); creating = false; return; }

  const btn = document.getElementById("createSubmitBtn");
  if (btn) {
    btn.disabled = true;
    btn.innerText = (formMode === "edit") ? "수정 중..." : "등록 중...";
  }

  try {
    let noticeId = null;

    if (formMode === "create") {
      // 1) 생성
      const created = await apiFetch(`${Notice_BASE}/items`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ category, title, content })
      });

      noticeId = created?.noticeId;
      if (!noticeId) {
        alert((created?.message ?? "공지 등록 완료") + "\n(첨부 업로드를 위해 noticeId 반환이 필요합니다.)");
        closeCreateModal();
        return;
      }

      // 생성 성공 메시지 (첨부 업로드 전/후는 선택)
      // alert(created?.message ?? "공지 등록 완료");

    } else {
      // 2) 수정
      if (!editingNoticeId) {
        alert("수정 대상 noticeId가 없습니다.");
        return;
      }

      const updated = await apiFetch(`${Notice_BASE}/items/${editingNoticeId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ category, title, content })
      });

      noticeId = editingNoticeId;

      // 수정 성공 메시지
      // alert(updated?.message ?? "공지 수정 완료");
    }

    // 3) (선택) 첨부 업로드: create든 edit든 파일 있으면 "추가 업로드"로 처리 가능
    const filesInput = document.getElementById("cFiles");
    const files = filesInput?.files;

    if (files && files.length > 0) {
      try {
        const fd = new FormData();
        Array.from(files).forEach((f) => fd.append("files", f));

        await apiFetch(`${Notice_BASE}/items/${noticeId}/attachments`, {
          method: "POST",
          body: fd
        });
      } catch (uploadErr) {
        console.error("첨부 업로드 실패:", uploadErr);
        alert("본문 처리는 완료됐지만, 첨부파일 업로드에 실패했습니다.");
      }
    }

    alert(formMode === "edit" ? "공지 수정 완료" : "공지 등록 완료");
    closeCreateModal();

    // 4) 목록 갱신
    try {
      state.page = 1;
      await loadNotices();
    } catch (refreshErr) {
      console.warn("목록 갱신 실패:", refreshErr);
    }

  } catch (err) {
    console.error(err);
    alert(formMode === "edit" ? "공지 수정에 실패했습니다." : "공지 등록에 실패했습니다.");
  } finally {
    creating = false;
    if (btn) {
      btn.disabled = false;
      btn.innerText = (formMode === "edit") ? "수정" : "등록";
    }
  }
}



  // ESC로 모달 닫기
  window.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      closeModal();
      closeCreateModal();
    }
  });

 // =========================
  // 5) t삭제
  // =========================


  async function deleteFromDetail() {
  if (!currentNoticeId) {
    alert("삭제할 공지 ID를 찾을 수 없습니다.");
    return;
  }

  if (!confirm("정말 이 공지를 삭제하시겠습니까?")) return;

  try {
    const res = await apiFetch(`${Notice_BASE}/items/${currentNoticeId}`, {
      method: "DELETE"
    });

    alert(res?.message ?? "공지 삭제 완료");
    closeModal();

    // 목록 갱신 (실패해도 삭제 실패로 보진 않음)
    try {
      state.page = 1;
      await loadNotices();
    } catch (refreshErr) {
      console.warn("목록 갱신 실패:", refreshErr);
    }

  } catch (err) {
    console.error(err);
    alert("공지 삭제에 실패했습니다.");
  }
}


function formatBytes(bytes) {
  if (!bytes && bytes !== 0) return "";
  const units = ["B", "KB", "MB", "GB"];
  let v = Number(bytes);
  let i = 0;
  while (v >= 1024 && i < units.length - 1) { v /= 1024; i++; }
  return `${v.toFixed(i === 0 ? 0 : 1)} ${units[i]}`;
}

async function loadExistingAttachmentsForEdit(noticeId) {
  const box = document.getElementById("existingAttachmentsBox");
  const host = document.getElementById("cExistingAttachments");
  if (!box || !host) return;

  box.style.display = "block";
  host.innerHTML = `<div style="color:var(--muted); font-size:12.5px;">불러오는 중...</div>`;

  try {
    const list = await apiFetch(`${Notice_BASE}/items/${noticeId}/attachments`);
    if (!Array.isArray(list) || list.length === 0) {
      host.innerHTML = `<div style="color:var(--muted); font-size:12.5px;">기존 첨부파일이 없습니다.</div>`;
      return;
    }

    host.innerHTML = "";
    list.forEach((a) => {
      const row = document.createElement("div");
      row.style.display = "flex";
      row.style.gap = "8px";
      row.style.alignItems = "center";
      row.style.justifyContent = "space-between";
      row.style.border = "1px solid var(--line)";
      row.style.borderRadius = "12px";
      row.style.padding = "10px 12px";
      row.style.background = "#fff";

      const left = document.createElement("div");
      left.style.display = "flex";
      left.style.flexDirection = "column";
      left.style.gap = "2px";

      const name = document.createElement("div");
      name.style.fontSize = "13px";
      name.style.fontWeight = "800";
      name.innerText = a.originalName ?? a.fileName ?? ("attachment#" + a.attachmentId);

      const meta = document.createElement("div");
      meta.style.fontSize = "12px";
      meta.style.color = "var(--muted)";
      meta.innerText = `${a.contentType ?? ""} ${a.sizeBytes ? formatBytes(a.sizeBytes) : ""}`.trim();

      left.appendChild(name);
      left.appendChild(meta);

      const actions = document.createElement("div");
      actions.style.display = "flex";
      actions.style.gap = "8px";
      actions.style.alignItems = "center";

      const delBtn = document.createElement("button");
      delBtn.className = "btn";
      delBtn.type = "button";
      delBtn.innerText = "삭제";
      delBtn.onclick = async () => {
        await deleteAttachmentFromEdit(a.attachmentId, noticeId);
      };

      actions.appendChild(delBtn);

      row.appendChild(left);
      row.appendChild(actions);
      host.appendChild(row);
    });
  } catch (e) {
    console.error(e);
    host.innerHTML = `<div style="color:var(--muted); font-size:12.5px;">기존 첨부파일을 불러오지 못했습니다.</div>`;
  }
}

async function deleteAttachmentFromEdit(attachmentId, noticeId) {
  if (!attachmentId) {
    alert("삭제할 첨부 ID를 찾을 수 없습니다.");
    return;
  }
  if (!confirm("이 첨부파일을 삭제하시겠습니까?")) return;

  try {
    const res = await apiFetch(`${Notice_BASE}/attachments/${attachmentId}`, {
      method: "DELETE"
    });

    alert(res?.message ?? "첨부 삭제 완료");

    // ✅ 수정 모달의 기존 첨부 목록 즉시 갱신
    await loadExistingAttachmentsForEdit(noticeId);

    // (선택) 상세 모달이 열려있는 상태라면 그쪽도 갱신하고 싶을 때:
    // if (document.getElementById("modalBackdrop")?.style.display === "flex") {
    //   await loadAttachmentsIntoModal(noticeId);
    // }

  } catch (e) {
    console.error(e);
    alert("첨부 삭제에 실패했습니다.");
  }
}


  // =========================
  // 5) 초기 로딩
  // =========================
  document.addEventListener("DOMContentLoaded", () => {
    loadNotices().catch(console.error);
  });

  function goPage(page) {
  if (page < 1 || page > state.totalPages) return;

  state.page = page;
  applyPaging();
  renderNoticeList();
  renderPagination();

  // 선택: 페이지 이동 시 상단으로
  // window.scrollTo({ top: 0, behavior: "smooth" });
}

function renderPagination() {
  paginationEl.innerHTML = "";

  if (state.totalPages <= 1) return; // ✅ 5개 이하면 페이지네이션 숨김

  const wrap = document.createElement("div");
  wrap.style.display = "flex";
  wrap.style.gap = "8px";
  wrap.style.alignItems = "center";

  // Prev
  const prev = document.createElement("button");
  prev.className = "btn";
  prev.type = "button";
  prev.innerText = "이전";
  prev.disabled = (state.page <= 1);
  prev.onclick = () => goPage(state.page - 1);

  // Next
  const next = document.createElement("button");
  next.className = "btn";
  next.type = "button";
  next.innerText = "다음";
  next.disabled = (state.page >= state.totalPages);
  next.onclick = () => goPage(state.page + 1);

  // Page numbers (최대 5개만 표시)
  const maxBtns = 5;
  let start = Math.max(1, state.page - Math.floor(maxBtns / 2));
  let end = start + maxBtns - 1;
  if (end > state.totalPages) {
    end = state.totalPages;
    start = Math.max(1, end - maxBtns + 1);
  }

  const info = document.createElement("span");
  info.className = "page-info";
  info.innerText = `${state.page} / ${state.totalPages}`;

  wrap.appendChild(prev);

  for (let p = start; p <= end; p++) {
    const b = document.createElement("button");
    b.className = (p === state.page) ? "btn primary" : "btn";
    b.type = "button";
    b.innerText = String(p);
    b.onclick = () => goPage(p);
    wrap.appendChild(b);
  }

  wrap.appendChild(info);
  wrap.appendChild(next);

  paginationEl.appendChild(wrap);
}


  // 전역 노출 (onclick에서 사용)
  window.resetSearch = resetSearch;
  window.openNotice = openNotice;
  window.closeModal = closeModal;
  window.goPage = goPage;

  window.openCreateModal = openCreateModal;
  window.closeCreateModal = closeCreateModal;
  window.submitCreateNotice = submitCreateNotice;
  window.deleteFromDetail = deleteFromDetail;
  window.openEditFromDetail = openEditFromDetail;


</script>


</body>
</html>
